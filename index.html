<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Data Extractor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 10px -5px rgba(0, 0, 0, 0.04);
        }
        .citation-badge {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .citation-badge:hover {
            background-color: #d1e0fc;
        }
        /* Ensure the chart container is responsive */
        #chartContainer {
            position: relative;
            height: 40vh; /* Set a default height */
            width: 100%;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-start justify-center">

    <div id="app" class="w-full max-w-4xl mt-6 container-card bg-white p-6 md:p-8 rounded-xl">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800 border-b pb-2">
                Global Company Financial Summary Generator
            </h1>
            <p class="text-gray-500 mt-1">
                Use the Gemini API to fetch and summarize key financial data (P&L, Balance Sheet, etc.) for any company globally.
            </p>
        </header>

        <!-- Input and Action Section -->
        <div class="flex flex-col md:flex-row gap-4 mb-8">
            <input type="text" id="companyName" placeholder="Enter Company Name (e.g., Apple, Reliance Industries, Toyota)"
                   class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm"
                   required>
            <button id="fetchDataButton"
                    class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 ease-in-out shadow-md">
                Get Financial Data & Charts
            </button>
        </div>

        <!-- Output Section -->
        <div id="outputArea" class="space-y-8">
            <div id="loadingIndicator" class="hidden text-center p-4 text-blue-600 font-medium">
                <svg class="animate-spin h-5 w-5 text-blue-500 inline-block mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Searching and generating data and visualizations...
            </div>
            
            <!-- Chart Container -->
            <div id="chartContainer" class="hidden bg-white p-4 md:p-6 rounded-lg border border-gray-200 shadow-inner">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Revenue & Profit Trend</h2>
                <canvas id="financialChart"></canvas>
            </div>

            <!-- Summary Container -->
            <div id="summaryContainer" class="hidden bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Financial Summary</h2>
                <div id="financialSummary" class="prose max-w-none text-gray-800 leading-relaxed">
                    <!-- Summary content will be injected here -->
                </div>
            </div>

            <div id="citationsContainer" class="hidden pt-4 border-t border-gray-200">
                <h3 class="text-sm font-medium text-gray-600 mb-2">Sources (Grounding Metadata)</h3>
                <div id="citationList" class="flex flex-wrap gap-2">
                    <!-- Citation badges will be injected here -->
                </div>
            </div>

            <div id="errorMessage" class="hidden p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                <!-- Error messages will be injected here -->
            </div>
        </div>
    </div>

    <script type="module">
        let chartInstance = null; // To hold the Chart.js instance for destruction/update

        // Helper function for exponential backoff
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        /**
         * Renders the Chart.js visualization using the structured data.
         * @param {Array} data - Array of {year, revenue, profit} objects.
         * @param {string} currency - The unit/currency string (e.g., "USD Billions").
         */
        function renderChart(data, currency, companyName) {
            const ctx = document.getElementById('financialChart').getContext('2d');
            
            // Sort data by year just in case the LLM returned it out of order
            data.sort((a, b) => a.year - b.year);
            
            const years = data.map(d => d.year.toString());
            const revenues = data.map(d => d.revenue);
            const profits = data.map(d => d.profit);

            // Destroy previous chart instance if it exists
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: `Revenue (${currency})`,
                            data: revenues,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)', // Blue
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: `Profit (${currency})`,
                            data: profits,
                            type: 'line', // Make profit a line for contrast
                            borderColor: 'rgba(239, 68, 68, 1)', // Red
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            tension: 0.3,
                            fill: false,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Annual Financial Performance for ${companyName}`,
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toLocaleString() + ' ' + currency;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Fiscal Year'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: `Value in ${currency}`
                            }
                        }
                    }
                }
            });
        }

        /**
         * Fetches financial data summary and structured data using the Gemini API.
         * @param {string} companyName - The name of the company to search for.
         */
        async function fetchFinancialData(companyName) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const summaryContainer = document.getElementById('summaryContainer');
            const financialSummary = document.getElementById('financialSummary');
            const citationsContainer = document.getElementById('citationsContainer');
            const chartContainer = document.getElementById('chartContainer');
            const citationList = document.getElementById('citationList');
            const errorMessage = document.getElementById('errorMessage');

            // Reset previous results
            financialSummary.innerHTML = '';
            citationList.innerHTML = '';
            summaryContainer.classList.add('hidden');
            citationsContainer.classList.add('hidden');
            chartContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            
            // --- Gemini API Configuration ---
            const textPrompt = `Find the latest quarterly results and 5 years of annual financial data (Revenue and Profit) for the company: ${companyName}. Focus on data from credible sources like Screener.in or equivalent. The output must be a single JSON object.`;
            
            const systemPrompt = `You are a specialized financial data generator. 
CRITICAL TASK: Generate a single JSON object conforming strictly to the provided schema. 
1. The 'summaryText' must be a concise, well-formatted, single-paragraph summary of the company's performance. DO NOT include any introductory or concluding sentences outside the main summary paragraph. 
2. The 'financialData' array must contain exactly 5 years of data. 
3. Determine the company's primary currency and numbering system (e.g., USD Billions, INR Crores) and set it in the 'currency' field.
4. DO NOT use any LaTeX, math formatting, or markdown symbols in the 'summaryText' or 'currency' string.`;

            // IMPORTANT: If running this file on your local machine or a GitHub Page, you MUST replace the empty string below
            // with your actual, UNRESTRICTED Gemini API Key for it to work publicly.
            const apiKey = "" 

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const responseSchema = {
                type: "OBJECT",
                properties: {
                    "summaryText": { "type": "STRING" },
                    "financialData": {
                        "type": "ARRAY",
                        "description": "5 years of key annual financial data for charting (Revenue and Profit in millions/billions/crores).",
                        "items": {
                            "type": "OBJECT",
                            "properties": {
                                "year": { "type": "NUMBER" },
                                "revenue": { "type": "NUMBER" },
                                "profit": { "type": "NUMBER" }
                            },
                            "propertyOrdering": ["year", "revenue", "profit"]
                        }
                    }
                    ,
                    "currency": { "type": "STRING", "description": "Local currency and numbering format (e.g., USD Billions, INR Crores)." }
                },
                "propertyOrdering": ["summaryText", "financialData", "currency"]
            };


            const payload = {
                contents: [{ parts: [{ text: textPrompt }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };
            
            let result = null;
            const maxRetries = 5;
            let retryCount = 0;

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error('API HTTP Error:', response.status, errorBody);
                        
                        // If it's a 400 or 403, it's likely the API key or usage limit. Display immediately.
                        if (response.status >= 400 && response.status < 500) {
                            loadingIndicator.classList.add('hidden');
                            errorMessage.innerHTML = `<strong>API Error (Status ${response.status}):</strong> The API call failed. The most common cause is an invalid or restricted API key. Please check your key's validity and ensure it has no HTTP referrer restrictions.`;
                            errorMessage.classList.remove('hidden');
                            return; // Stop trying immediately for client errors
                        }
                        
                        // Throw for retry on 500 server errors
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    result = await response.json();
                    break; // Success, exit the retry loop

                } catch (error) {
                    retryCount++;
                    if (retryCount >= maxRetries) {
                        console.error('API call failed after multiple retries:', error);
                        errorMessage.innerHTML = '<strong>Error:</strong> Failed to fetch data from the Gemini API after multiple attempts. Please check your network connection or try again later.';
                        errorMessage.classList.remove('hidden');
                        loadingIndicator.classList.add('hidden');
                        return;
                    }
                    // Wait with exponential backoff
                    const waitTime = Math.pow(2, retryCount) * 1000;
                    await delay(waitTime);
                }
            }


            loadingIndicator.classList.add('hidden');

            const candidate = result.candidates?.[0];
            let jsonResponse = null;

            if (candidate && candidate.content?.parts?.[0]?.text) {
                 try {
                    const jsonString = candidate.content.parts[0].text;
                    jsonResponse = JSON.parse(jsonString);
                } catch (e) {
                    console.error("Failed to parse JSON response:", e);
                    errorMessage.innerHTML = '<strong>Error:</strong> Failed to parse the structured data from the model. Please try again.';
                    errorMessage.classList.remove('hidden');
                    return;
                }
                
                // 1. Display the generated text summary
                if (jsonResponse.summaryText) {
                    financialSummary.innerHTML = jsonResponse.summaryText.trim().replace(/\n/g, '<br>');
                    summaryContainer.classList.remove('hidden');
                } else {
                    financialSummary.innerHTML = "No detailed text summary available.";
                    summaryContainer.classList.remove('hidden');
                }

                // 2. Render the chart
                if (jsonResponse.financialData && jsonResponse.financialData.length > 0 && jsonResponse.currency) {
                    renderChart(jsonResponse.financialData, jsonResponse.currency, companyName);
                    chartContainer.classList.remove('hidden');
                }

                
                // 3. Extract and display grounding sources
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title); // Ensure sources are valid
                }

                if (sources.length > 0) {
                    sources.forEach((source, index) => {
                        const badge = document.createElement('a');
                        badge.href = source.uri;
                        badge.target = "_blank";
                        badge.className = "citation-badge inline-flex items-center px-3 py-1 text-sm font-medium bg-blue-100 text-blue-800 rounded-full transition duration-150 ease-in-out";
                        badge.title = source.uri;
                        badge.innerHTML = `[${index + 1}] ${source.title}`;
                        citationList.appendChild(badge);
                    });
                    citationsContainer.classList.remove('hidden');
                }

            } else {
                errorMessage.innerHTML = '<strong>Error:</strong> Could not retrieve a summary for the company. Please check the name and try again.';
                errorMessage.classList.remove('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const fetchDataButton = document.getElementById('fetchDataButton');
            const companyNameInput = document.getElementById('companyName');

            fetchDataButton.addEventListener('click', () => {
                const companyName = companyNameInput.value.trim();
                if (companyName) {
                    fetchFinancialData(companyName);
                } else {
                    alert('Please enter a company name.');
                }
            });
            
            // Allow pressing Enter key
            companyNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    fetchDataButton.click();
                }
            });
        });

        // NOTE: Standard practice is to use a custom modal instead of alert().
        function alert(message) {
            const currentAlert = document.getElementById('custom-alert-modal');
            if (currentAlert) currentAlert.remove();

            const modalHtml = `
                <div id="custom-alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                        <h4 class="text-xl font-bold mb-4 text-blue-600">Input Required</h4>
                        <p class="text-gray-700">${message}</p>
                        <button onclick="document.getElementById('custom-alert-modal').remove()"
                                class="mt-4 w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150">
                            OK
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

    </script>
</body>
</html>
